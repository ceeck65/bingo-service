# üé≤ Microservicio de Bingo - Documentaci√≥n Completa

> **Sistema Multi-Tenant con Pool de Cartones para Laravel/Vue, WhatsApp y Telegram**

---

## üìë Tabla de Contenidos

1. [Introducci√≥n](#introducci√≥n)
2. [Caracter√≠sticas del Sistema](#caracter√≠sticas-del-sistema)
3. [Instalaci√≥n y Configuraci√≥n](#instalaci√≥n-y-configuraci√≥n)
4. [Tipos de Bingo](#tipos-de-bingo)
5. [Arquitectura Multi-Tenant](#arquitectura-multi-tenant)
6. [Sistema de Pool de Cartones](#sistema-de-pool-de-cartones)
7. [API REST - Endpoints](#api-rest---endpoints)
8. [Integraci√≥n con Laravel/Vue](#integraci√≥n-con-laravelvue)
9. [Integraci√≥n con WhatsApp](#integraci√≥n-con-whatsapp)
10. [Integraci√≥n con Telegram](#integraci√≥n-con-telegram)
11. [Patrones Ganadores](#patrones-ganadores)
12. [Scripts de Prueba](#scripts-de-prueba)
13. [Soluci√≥n de Problemas](#soluci√≥n-de-problemas)
14. [Estructura del Proyecto](#estructura-del-proyecto)

---

## üìñ Introducci√≥n

Este microservicio Django proporciona una soluci√≥n completa para gestionar juegos de bingo en l√≠nea. Est√° dise√±ado espec√≠ficamente para ser consumido por:

- **Web Apps (Laravel/Vue)** - Interfaz web completa
- **WhatsApp Business API** - Bots y comandos por WhatsApp
- **Telegram Bot API** - Bots y comandos por Telegram
- **Sistemas Whitelabel** - M√∫ltiples operadores/marcas

### ¬øQu√© lo hace especial?

‚úÖ **Multi-Tenant** - Cada operador tiene su espacio aislado  
‚úÖ **Pool de Cartones** - Los jugadores seleccionan cartones pre-generados  
‚úÖ **3 Tipos de Bingo** - Soporta 75, 85 y 90 bolas  
‚úÖ **Validaci√≥n Autom√°tica** - Detecta ganadores autom√°ticamente  
‚úÖ **Reutilizaci√≥n** - Los cartones pueden usarse en m√∫ltiples sesiones  
‚úÖ **APIs Completas** - REST API para todas las funcionalidades  

---

## üéØ Caracter√≠sticas del Sistema

### Funcionalidades Core

- ‚úÖ Generaci√≥n autom√°tica de cartones v√°lidos
- ‚úÖ Validaci√≥n completa de reglas de bingo
- ‚úÖ Sistema de validaci√≥n de ganadores con m√∫ltiples patrones
- ‚úÖ Sistema de partidas con extracci√≥n de bolas
- ‚úÖ API REST completa y documentada
- ‚úÖ Soporte para tres tipos de bingo (75, 85, 90 bolas)
- ‚úÖ Generaci√≥n de m√∫ltiples cartones simult√°neos
- ‚úÖ Estad√≠sticas detalladas del sistema

### Sistema Multi-Tenant

- ‚úÖ Operadores/marcas con aislamiento completo de datos
- ‚úÖ Jugadores √∫nicos por operador
- ‚úÖ Sesiones de bingo organizadas y configurables
- ‚úÖ Branding personalizado (colores, logos, dominios)
- ‚úÖ Configuraciones flexibles por operador
- ‚úÖ L√≠mites configurables (cartones por jugador/partida)
- ‚úÖ Integraci√≥n con WhatsApp y Telegram

### Sistema de Pool de Cartones

- ‚úÖ Operador define cantidad de cartones al crear sesi√≥n
- ‚úÖ Cartones se generan una sola vez
- ‚úÖ Jugadores seleccionan de cartones existentes
- ‚úÖ Sistema de estados (disponible/reservado/vendido)
- ‚úÖ Reutilizaci√≥n de cartones entre sesiones
- ‚úÖ Trazabilidad completa de selecciones

---

## üöÄ Instalaci√≥n y Configuraci√≥n

### Requisitos Previos

- Python 3.8+
- PostgreSQL 12+
- pip (gestor de paquetes de Python)

### Configuraci√≥n R√°pida

```bash
# 1. Clonar o navegar al proyecto
cd /home/ceeck65/Projects/bingo_service

# 2. Instalar dependencias
pip install -r requirements.txt

# 3. Configurar base de datos PostgreSQL
# La configuraci√≥n est√° en bingo_service/settings.py:
# - Database: bingo
# - User: postgres
# - Password: 123456
# - Host: localhost
# - Port: 5432

# 4. Aplicar migraciones
python3 manage.py migrate

# 5. Crear superusuario (opcional)
python3 manage.py createsuperuser

# 6. Iniciar servidor
python3 manage.py runserver
```

### Variables de Entorno

El proyecto usa las siguientes configuraciones:

```python
# Base de Datos
DATABASE_NAME = 'bingo'
DATABASE_USER = 'postgres'
DATABASE_PASSWORD = '123456'
DATABASE_HOST = 'localhost'
DATABASE_PORT = '5432'
```

### Dependencias

```
Django==5.2.7
djangorestframework==3.16.1
django-cors-headers==4.6.0
psycopg==3.1.18
```

---

## üé≤ Tipos de Bingo

### Bingo de 75 Bolas (Americano Cl√°sico)

- **Formato**: 5x5 con centro libre (FREE)
- **Distribuci√≥n por columnas**:
  - **B**: n√∫meros 1-15
  - **I**: n√∫meros 16-30
  - **N**: n√∫meros 31-45 (centro libre)
  - **G**: n√∫meros 46-60
  - **O**: n√∫meros 61-75

**Ejemplo de cart√≥n:**
```
  B    I    N    G    O
  7   26  FREE  53   66
 15   28   44   60   65
 11   24   41   47   72
  5   16   38   59   73
  2   29   31   50   64
```

### Bingo de 85 Bolas (Americano Extendido)

- **Formato**: 5x5 con centro libre
- **Distribuci√≥n por columnas**:
  - **B**: n√∫meros 1-16
  - **I**: n√∫meros 17-32
  - **N**: n√∫meros 33-48 (centro libre)
  - **G**: n√∫meros 49-64
  - **O**: n√∫meros 65-80

### Bingo de 90 Bolas (Europeo)

- **Formato**: 3x9 (3 filas, 9 columnas)
- **N√∫meros por fila**: Exactamente 5 n√∫meros y 4 espacios vac√≠os
- **Distribuci√≥n por columnas**:
  - Columna 1: n√∫meros 1-9
  - Columna 2: n√∫meros 10-19
  - ...
  - Columna 9: n√∫meros 80-90

**Ejemplo de cart√≥n:**
```
  5  --  23  --  45  --  67  82  --
 --  12  --  34  --  56  --  --  89
  9  --  29  --  48  --  71  --  90
```

---

## üè¢ Arquitectura Multi-Tenant

### Estructura Jer√°rquica

```
Operador (BingoMax)
‚îú‚îÄ‚îÄ Configuraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ Branding (logo, colores)
‚îÇ   ‚îú‚îÄ‚îÄ Tipos de bingo permitidos
‚îÇ   ‚îî‚îÄ‚îÄ L√≠mites configurables
‚îú‚îÄ‚îÄ Jugadores
‚îÇ   ‚îú‚îÄ‚îÄ Juan (WhatsApp: +1234567890)
‚îÇ   ‚îú‚îÄ‚îÄ Mar√≠a (Telegram: @maria_max)
‚îÇ   ‚îî‚îÄ‚îÄ Carlos (Email: carlos@bingomax.com)
‚îú‚îÄ‚îÄ Sesiones
‚îÇ   ‚îú‚îÄ‚îÄ Sesi√≥n Matutina (75 bolas, 100 cartones)
‚îÇ   ‚îî‚îÄ‚îÄ Gran Torneo (85 bolas, 200 cartones)
‚îî‚îÄ‚îÄ Estad√≠sticas
    ‚îú‚îÄ‚îÄ Jugadores activos
    ‚îú‚îÄ‚îÄ Sesiones realizadas
    ‚îî‚îÄ‚îÄ Cartones vendidos
```

### Modelos Principales

#### 1. Operator (Operador/Marca)

```python
{
  "id": "uuid",
  "name": "BingoMax",
  "code": "bingomax",
  "domain": "bingomax.com",
  "logo_url": "https://bingomax.com/logo.png",
  "primary_color": "#FF6B35",
  "secondary_color": "#F7931E",
  "allowed_bingo_types": ["75", "85", "90"],
  "max_cards_per_player": 5,
  "max_cards_per_game": 100
}
```

#### 2. Player (Jugador)

```python
{
  "id": "uuid",
  "operator": "operator-uuid",
  "username": "juan_max",
  "email": "juan@bingomax.com",
  "phone": "+1234567890",
  "whatsapp_id": "1234567890",
  "telegram_id": "juan_max_tg",
  "is_active": true,
  "is_verified": true
}
```

#### 3. BingoSession (Sesi√≥n)

```python
{
  "id": "uuid",
  "operator": "operator-uuid",
  "name": "Sesi√≥n Matutina",
  "bingo_type": "75",
  "total_cards": 100,
  "max_players": 50,
  "entry_fee": 5.00,
  "scheduled_start": "2024-01-15T10:00:00Z",
  "status": "scheduled"
}
```

---

## üéÆ Sistema de Pool de Cartones

### Concepto

En lugar de generar un cart√≥n nuevo cada vez que un jugador se une, el sistema funciona con un **pool (inventario) de cartones pre-generados** que los jugadores pueden seleccionar.

### Flujo Completo

```
1. OPERADOR CREA SESI√ìN
   ‚îú‚îÄ> Define: nombre, tipo bingo, fecha/hora
   ‚îî‚îÄ> Define: total_cards = 100

2. SISTEMA GENERA CARTONES
   ‚îú‚îÄ> Crea 100 cartones √∫nicos
   ‚îú‚îÄ> Estado inicial: "available"
   ‚îî‚îÄ> Numerados: #1, #2, #3, ..., #100

3. JUGADOR VE CARTONES DISPONIBLES
   ‚îú‚îÄ> GET /sessions/{id}/available-cards/
   ‚îî‚îÄ> Ve todos los cartones con preview

4. JUGADOR SELECCIONA CART√ìN
   ‚îú‚îÄ> POST /cards/select/
   ‚îú‚îÄ> Estado cambia a: "reserved"
   ‚îî‚îÄ> Tiene 10 min para confirmar

5. JUGADOR CONFIRMA COMPRA
   ‚îú‚îÄ> POST /cards/confirm-purchase/
   ‚îú‚îÄ> Estado cambia a: "sold"
   ‚îî‚îÄ> Cart√≥n listo para jugar

6. ALTERNATIVA: LIBERAR CART√ìN
   ‚îú‚îÄ> POST /cards/release/
   ‚îú‚îÄ> Estado vuelve a: "available"
   ‚îî‚îÄ> Otro jugador puede seleccionarlo
```

### Estados de los Cartones

| Estado | Descripci√≥n | Acci√≥n Permitida |
|--------|-------------|------------------|
| **available** | Disponible para selecci√≥n | Puede ser reservado |
| **reserved** | Reservado por un jugador | Puede confirmar o liberar |
| **sold** | Comprado y confirmado | Participa en la partida |
| **cancelled** | Cancelado por operador | No puede usarse |

### Ventajas

‚úÖ **Control**: Operador define exactamente cu√°ntos cartones existen  
‚úÖ **Transparencia**: Jugadores ven todos los cartones disponibles  
‚úÖ **Eficiencia**: Se generan una sola vez  
‚úÖ **Elecci√≥n**: Jugadores pueden elegir su cart√≥n favorito  
‚úÖ **M√∫ltiples Cartones**: Jugadores pueden jugar con varios cartones simult√°neamente  
‚úÖ **Reutilizaci√≥n**: Mismos cartones en m√∫ltiples sesiones  

### Jugador con M√∫ltiples Cartones

Un jugador puede seleccionar y jugar con m√∫ltiples cartones en la misma sesi√≥n:

#### L√≠mites Configurables

Cada operador define el m√°ximo de cartones por jugador:

```python
operator.max_cards_per_player = 5  # M√°ximo 5 cartones
```

#### Selecci√≥n M√∫ltiple

**Opci√≥n 1: Seleccionar uno por uno**
```bash
# Seleccionar cart√≥n #1
POST /api/multi-tenant/cards/select/
{"session_id": "...", "player_id": "...", "card_id": "card-1"}

# Seleccionar cart√≥n #2
POST /api/multi-tenant/cards/select/
{"session_id": "...", "player_id": "...", "card_id": "card-2"}
```

**Opci√≥n 2: Seleccionar m√∫ltiples a la vez (Recomendado)**
```bash
POST /api/multi-tenant/cards/select-multiple/
{
  "session_id": "session-uuid",
  "player_id": "player-uuid",
  "card_ids": ["card-1", "card-2", "card-3"]
}
```

#### Ver Cartones del Jugador

```bash
GET /api/multi-tenant/sessions/{session-id}/player/{player-id}/cards/

Respuesta:
{
  "summary": {
    "total": 3,
    "reserved": 3,
    "sold": 0
  },
  "cards": [
    {
      "id": "card-uuid-1",
      "card_number": 1,
      "status": "reserved",
      "numbers": [...]
    },
    ...
  ]
}
```

#### Confirmaci√≥n en Bloque

Confirmar todos los cartones reservados de un jugador:

```bash
POST /api/multi-tenant/cards/confirm-multiple-purchase/
{
  "session_id": "session-uuid",
  "player_id": "player-uuid"
}

Respuesta:
{
  "message": "3 cartones confirmados exitosamente",
  "total_cost": 15.00,
  "total_cards": 3
}
```

#### Ventajas de M√∫ltiples Cartones

‚úÖ **Mayor probabilidad de ganar** - M√°s cartones = m√°s chances  
‚úÖ **Control de l√≠mites** - Operador define m√°ximo  
‚úÖ **Proceso optimizado** - Selecci√≥n y compra en bloque  
‚úÖ **Transparencia** - El jugador ve todos sus cartones  

---

## üì° API REST - Endpoints

### Base URLs

- **APIs B√°sicas**: `http://localhost:8000/api/bingo/`
- **APIs Multi-Tenant**: `http://localhost:8000/api/multi-tenant/`

### Operadores

```bash
# Listar operadores
GET /api/multi-tenant/operators/

# Crear operador
POST /api/multi-tenant/operators/
{
  "name": "Mi Bingo",
  "code": "mibingo",
  "allowed_bingo_types": ["75", "85", "90"]
}

# Obtener operador espec√≠fico
GET /api/multi-tenant/operators/{id}/

# Estad√≠sticas del operador
GET /api/multi-tenant/operators/{id}/statistics/
```

### Jugadores

```bash
# Listar jugadores
GET /api/multi-tenant/players/?operator={operator-id}

# Crear jugador
POST /api/multi-tenant/players/
{
  "operator": "operator-uuid",
  "username": "juan123",
  "email": "juan@example.com",
  "phone": "+1234567890"
}

# Registrar por tel√©fono (WhatsApp/Telegram)
POST /api/multi-tenant/players/register-by-phone/
{
  "operator_code": "mibingo",
  "phone": "+1234567890",
  "username": "juan_whatsapp"
}

# Vincular cuenta social
POST /api/multi-tenant/players/link-social/
{
  "player_id": "player-uuid",
  "whatsapp_id": "whatsapp-user-id"
}
```

### Sesiones

```bash
# Listar sesiones
GET /api/multi-tenant/sessions/?operator={operator-id}

# Crear sesi√≥n
POST /api/multi-tenant/sessions/
{
  "operator": "operator-uuid",
  "name": "Sesi√≥n Matutina",
  "bingo_type": "75",
  "total_cards": 100,
  "max_players": 50,
  "entry_fee": 5.00,
  "scheduled_start": "2024-01-15T10:00:00Z"
}

# Obtener sesi√≥n espec√≠fica
GET /api/multi-tenant/sessions/{id}/

# Estad√≠sticas de la sesi√≥n
GET /api/multi-tenant/sessions/{id}/statistics/

# Unirse a una sesi√≥n
POST /api/multi-tenant/sessions/join/
{
  "session_id": "session-uuid",
  "player_id": "player-uuid",
  "cards_count": 3
}
```

### Cartones

```bash
# Generar cartones para sesi√≥n
POST /api/multi-tenant/cards/generate-for-session/
{
  "session_id": "session-uuid",
  "generate_now": true
}

# Ver cartones disponibles
GET /api/multi-tenant/sessions/{session-id}/available-cards/

# Seleccionar un cart√≥n
POST /api/multi-tenant/cards/select/
{
  "session_id": "session-uuid",
  "player_id": "player-uuid",
  "card_id": "card-uuid"
}

# ‚≠ê NUEVO: Seleccionar m√∫ltiples cartones a la vez
POST /api/multi-tenant/cards/select-multiple/
{
  "session_id": "session-uuid",
  "player_id": "player-uuid",
  "card_ids": [
    "card-uuid-1",
    "card-uuid-2",
    "card-uuid-3"
  ]
}

# ‚≠ê NUEVO: Ver todos los cartones de un jugador
GET /api/multi-tenant/sessions/{session-id}/player/{player-id}/cards/

# Confirmar compra de un cart√≥n
POST /api/multi-tenant/cards/confirm-purchase/
{
  "card_id": "card-uuid"
}

# ‚≠ê NUEVO: Confirmar compra de todos los cartones reservados
POST /api/multi-tenant/cards/confirm-multiple-purchase/
{
  "session_id": "session-uuid",
  "player_id": "player-uuid"
}

# Liberar cart√≥n
POST /api/multi-tenant/cards/release/
{
  "card_id": "card-uuid"
}

# Reutilizar cartones en nueva sesi√≥n
POST /api/multi-tenant/cards/reuse/
{
  "new_session_id": "new-session-uuid",
  "old_session_id": "old-session-uuid"
}
```

### Partidas

```bash
# Listar partidas
GET /api/multi-tenant/games/?operator={operator-id}
GET /api/multi-tenant/games/?session={session-id}

# Crear partida
POST /api/multi-tenant/games/
{
  "operator": "operator-uuid",
  "session": "session-uuid",
  "game_type": "75",
  "name": "Partida Principal",
  "auto_draw": false
}

# Obtener partida espec√≠fica
GET /api/multi-tenant/games/{game-id}/

# Obtener partida activa de una sesi√≥n
GET /api/multi-tenant/sessions/{session-id}/game/

Respuesta:
{
  "game": {
    "id": "game-uuid",
    "name": "Partida Principal",
    "game_type": "75",
    "is_active": true
  },
  "session": {
    "id": "session-uuid",
    "name": "Sesi√≥n Matutina",
    "status": "active"
  },
  "stats": {
    "balls_drawn": 15,
    "total_cards": 45,
    "players": 12
  }
}

# Extraer bola
POST /api/multi-tenant/games/draw-ball/
{
  "game_id": "game-uuid"
}

Respuesta:
{
  "message": "Bola 42 extra√≠da",
  "ball_number": 42,
  "total_drawn": 15
}

# Ver bolas extra√≠das
GET /api/multi-tenant/games/{game-id}/drawn-balls/

Respuesta:
{
  "game": {...},
  "total_drawn": 15,
  "balls": [5, 12, 23, 34, 42, ...],
  "details": [
    {"number": 5, "drawn_at": "2024-01-15T10:05:00Z"},
    ...
  ]
}

# Verificar ganador (un cart√≥n)
POST /api/multi-tenant/games/check-winner/
{
  "card_id": "card-uuid",
  "game_id": "game-uuid"
}

Respuesta:
{
  "card": {...},
  "winner_result": {
    "is_winner": true,
    "winning_patterns": ["L√≠nea horizontal (fila 1)"],
    "marked_numbers": [7, 26, 41, 53, 66]
  },
  "drawn_balls_count": 25
}
```

---

## üåê Integraci√≥n con Laravel/Vue

### Servicio de Bingo en Laravel

```php
// app/Services/BingoService.php
namespace App\Services;

use Illuminate\Support\Facades\Http;

class BingoService
{
    protected $apiUrl;
    protected $operatorId;
    
    public function __construct()
    {
        $this->apiUrl = config('bingo.api_url');
        $this->operatorId = config('bingo.operator_id');
    }
    
    // Crear sesi√≥n
    public function createSession($data)
    {
        return Http::post($this->apiUrl . 'sessions/', [
            'operator' => $this->operatorId,
            'name' => $data['name'],
            'bingo_type' => $data['type'],
            'total_cards' => $data['total_cards'],
            'max_players' => $data['max_players'],
            'entry_fee' => $data['price'],
            'scheduled_start' => $data['start_time']
        ])->json();
    }
    
    // Generar cartones
    public function generateCards($sessionId)
    {
        return Http::post($this->apiUrl . 'cards/generate-for-session/', [
            'session_id' => $sessionId,
            'generate_now' => true
        ])->json();
    }
    
    // Obtener cartones disponibles
    public function getAvailableCards($sessionId)
    {
        return Http::get(
            $this->apiUrl . "sessions/{$sessionId}/available-cards/"
        )->json();
    }
    
    // Seleccionar cart√≥n
    public function selectCard($sessionId, $playerId, $cardId)
    {
        return Http::post($this->apiUrl . 'cards/select/', [
            'session_id' => $sessionId,
            'player_id' => $playerId,
            'card_id' => $cardId
        ])->json();
    }
    
    // Confirmar compra
    public function confirmPurchase($cardId)
    {
        return Http::post($this->apiUrl . 'cards/confirm-purchase/', [
            'card_id' => $cardId
        ])->json();
    }
}
```

### Componente Vue para Selecci√≥n de Cartones

```vue
<!-- resources/js/components/CardSelector.vue -->
<template>
  <div class="card-selector">
    <h2>Selecciona tu Cart√≥n</h2>
    
    <div class="cards-grid">
      <div 
        v-for="card in availableCards" 
        :key="card.id"
        class="card-item"
        :class="{ selected: selectedCard === card.id }"
        @click="selectCard(card)"
      >
        <div class="card-number">#{{ card.card_number }}</div>
        <div class="card-preview">
          <table>
            <thead>
              <tr>
                <th>B</th>
                <th>I</th>
                <th>N</th>
                <th>G</th>
                <th>O</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(row, i) in card.numbers" :key="i">
                <td v-for="(num, j) in row" :key="j">
                  {{ num === 'FREE' ? '‚òÖ' : num }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <button 
      @click="confirmSelection"
      :disabled="!selectedCard"
      class="btn-confirm"
    >
      Confirmar Selecci√≥n
    </button>
  </div>
</template>

<script>
export default {
  data() {
    return {
      availableCards: [],
      selectedCard: null,
      session: null
    }
  },
  
  async mounted() {
    await this.loadAvailableCards();
  },
  
  methods: {
    async loadAvailableCards() {
      try {
        const response = await axios.get(
          `/api/bingo/sessions/${this.$route.params.sessionId}/available-cards`
        );
        this.availableCards = response.data.cards;
        this.session = response.data.session;
      } catch (error) {
        this.$toast.error('Error cargando cartones');
      }
    },
    
    selectCard(card) {
      this.selectedCard = card.id;
    },
    
    async confirmSelection() {
      try {
        await axios.post('/api/bingo/cards/select', {
          session_id: this.session.id,
          player_id: this.$auth.user.id,
          card_id: this.selectedCard
        });
        
        this.$toast.success('Cart√≥n reservado. Procede al pago');
        this.$router.push('/checkout');
      } catch (error) {
        this.$toast.error('Error al seleccionar cart√≥n');
      }
    }
  }
}
</script>
```

---

## üì± Integraci√≥n con WhatsApp

### Comandos Disponibles

```
/sesiones - Ver sesiones activas
/cartones - Ver cartones disponibles
/seleccionar {n√∫mero} - Seleccionar un cart√≥n
/miscartas - Ver mis cartones
/estado - Ver estado de mi cuenta
/ayuda - Mostrar ayuda
```

### Implementaci√≥n en Laravel

```php
// app/Services/WhatsAppBingoService.php
namespace App\Services;

class WhatsAppBingoService
{
    protected $bingoService;
    
    public function __construct(BingoService $bingoService)
    {
        $this->bingoService = $bingoService;
    }
    
    public function processCommand($phone, $message)
    {
        $player = $this->getOrCreatePlayer($phone);
        
        switch (trim(strtolower($message))) {
            case '/sesiones':
                return $this->sendActiveSessions($player);
                
            case '/cartones':
                return $this->sendAvailableCards($player);
                
            case '/miscartas':
                return $this->sendPlayerCards($player);
                
            case '/ayuda':
                return $this->sendHelp($player);
                
            default:
                if (preg_match('/\/seleccionar (\d+)/', $message, $matches)) {
                    return $this->selectCard($player, $matches[1]);
                }
                return $this->sendHelp($player);
        }
    }
    
    private function sendActiveSessions($player)
    {
        $sessions = $this->bingoService->getActiveSessions();
        
        $message = "üéØ *Sesiones Activas:*\n\n";
        
        foreach ($sessions['results'] as $session) {
            $message .= "üé≤ *{$session['name']}*\n";
            $message .= "Tipo: {$session['bingo_type']} bolas\n";
            $message .= "Entrada: \${$session['entry_fee']}\n";
            $message .= "Disponibles: {$session['available_cards_count']}/{$session['total_cards']}\n";
            $message .= "------------------------\n";
        }
        
        $message .= "\nüìù Usa /cartones para ver los cartones disponibles";
        
        return $this->sendWhatsApp($player['phone'], $message);
    }
    
    private function sendAvailableCards($player)
    {
        $session = $this->bingoService->getActiveSession();
        $cards = $this->bingoService->getAvailableCards($session['id']);
        
        $message = "üé≤ *Cartones Disponibles: {$cards['session']['available_count']}*\n\n";
        
        // Mostrar primeros 10 cartones
        foreach (array_slice($cards['cards'], 0, 10) as $card) {
            $message .= "üìã *Cart√≥n #{$card['card_number']}*\n";
            $message .= "B: {$card['numbers'][0][0]} | ";
            $message .= "I: {$card['numbers'][0][1]} | ";
            $message .= "N: {$card['numbers'][0][2]} | ";
            $message .= "G: {$card['numbers'][0][3]} | ";
            $message .= "O: {$card['numbers'][0][4]}\n";
        }
        
        $message .= "\n‚úÖ Usa /seleccionar {n√∫mero} para elegir tu cart√≥n";
        
        return $this->sendWhatsApp($player['phone'], $message);
    }
    
    private function selectCard($player, $cardNumber)
    {
        try {
            $session = $this->bingoService->getActiveSession();
            $card = $this->findCardByNumber($session['id'], $cardNumber);
            
            $result = $this->bingoService->selectCard(
                $session['id'],
                $player['id'],
                $card['id']
            );
            
            $message = "‚úÖ *Cart√≥n #{$cardNumber} Reservado*\n\n";
            $message .= "Tienes 10 minutos para completar el pago.\n";
            $message .= "Precio: \${$session['entry_fee']}\n\n";
            $message .= "üí≥ Env√≠a el comprobante para confirmar.";
            
            return $this->sendWhatsApp($player['phone'], $message);
            
        } catch (\Exception $e) {
            return $this->sendWhatsApp(
                $player['phone'],
                "‚ùå Error: " . $e->getMessage()
            );
        }
    }
}
```

---

## üì± Integraci√≥n con Telegram

### Bot de Telegram

```php
// app/Services/TelegramBingoBot.php
namespace App\Services;

use Telegram\Bot\Api;
use Telegram\Bot\Keyboard\Keyboard;

class TelegramBingoBot
{
    protected $telegram;
    protected $bingoService;
    
    public function __construct(BingoService $bingoService)
    {
        $this->telegram = new Api(config('telegram.bot_token'));
        $this->bingoService = $bingoService;
    }
    
    public function handleUpdate($update)
    {
        $message = $update->getMessage();
        $chatId = $message->getChat()->getId();
        $text = $message->getText();
        $username = $message->getFrom()->getUsername();
        
        $player = $this->getOrCreatePlayer($chatId, $username);
        
        $this->processCommand($chatId, $text, $player);
    }
    
    private function processCommand($chatId, $text, $player)
    {
        switch ($text) {
            case '/start':
                $this->sendWelcome($chatId);
                break;
                
            case '/sesiones':
                $this->sendSessions($chatId);
                break;
                
            case '/cartones':
                $this->sendCards($chatId, $player);
                break;
                
            default:
                $this->sendHelp($chatId);
        }
    }
    
    private function sendWelcome($chatId)
    {
        $keyboard = Keyboard::make()
            ->inline()
            ->row([
                Keyboard::inlineButton([
                    'text' => 'üéØ Ver Sesiones',
                    'callback_data' => 'view_sessions'
                ])
            ])
            ->row([
                Keyboard::inlineButton([
                    'text' => 'üé≤ Ver Cartones',
                    'callback_data' => 'view_cards'
                ])
            ]);
        
        $this->telegram->sendMessage([
            'chat_id' => $chatId,
            'text' => "¬°Bienvenido al Bingo! üé≤\n\nSelecciona una opci√≥n:",
            'reply_markup' => $keyboard
        ]);
    }
    
    private function sendSessions($chatId)
    {
        $sessions = $this->bingoService->getActiveSessions();
        
        $text = "üéØ *Sesiones Activas:*\n\n";
        
        foreach ($sessions['results'] as $session) {
            $text .= "üé≤ *{$session['name']}*\n";
            $text .= "Tipo: {$session['bingo_type']} bolas\n";
            $text .= "Entrada: \${$session['entry_fee']}\n";
            $text .= "Disponibles: {$session['available_cards_count']}\n";
            $text .= "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n";
        }
        
        $this->telegram->sendMessage([
            'chat_id' => $chatId,
            'text' => $text,
            'parse_mode' => 'Markdown'
        ]);
    }
}
```

---

## üèÜ Patrones Ganadores

### Bingo de 75 Bolas (Americano)

- ‚úÖ **L√≠nea Horizontal** - Una fila completa
- ‚úÖ **L√≠nea Vertical** - Una columna completa (B, I, N, G, O)
- ‚úÖ **Diagonal Principal** - De esquina superior izquierda a inferior derecha
- ‚úÖ **Diagonal Secundaria** - De esquina superior derecha a inferior izquierda
- ‚úÖ **Cuatro Esquinas** - Las cuatro esquinas del cart√≥n
- ‚úÖ **Cart√≥n Completo** - Todo el cart√≥n marcado

### Bingo de 85 Bolas (Americano Extendido)

- ‚úÖ **L√≠nea Horizontal** - Una fila completa
- ‚úÖ **L√≠nea Vertical** - Una columna completa
- ‚úÖ **Diagonal Principal**
- ‚úÖ **Diagonal Secundaria**
- ‚úÖ **Cuatro Esquinas**
- ‚úÖ **Cart√≥n Completo**

### Bingo de 90 Bolas (Europeo)

- ‚úÖ **L√≠nea** - Una fila completa
- ‚úÖ **Dos L√≠neas** - Dos filas completas
- ‚úÖ **Cart√≥n Completo** - Las tres filas completas
- ‚úÖ **Columna** - Una columna completa (menos com√∫n)

---

## üß™ Scripts de Prueba

### Probar Sistema Completo

```bash
# Test de modelos
python3 test_models.py

# Demo de pool de cartones
python3 demo_pool_cartones.py

# Demo de 75 bolas
python3 demo_75_balls.py

# Demo multi-tenant
python3 demo_multi_tenant.py

# Test simple
python3 test_pool_simple.py
```

### Ejemplos con curl

```bash
# Crear operador
curl -X POST http://localhost:8000/api/multi-tenant/operators/ \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Bingo",
    "code": "testbingo",
    "allowed_bingo_types": ["75"]
  }'

# Crear sesi√≥n
curl -X POST http://localhost:8000/api/multi-tenant/sessions/ \
  -H "Content-Type: application/json" \
  -d '{
    "operator": "operator-uuid",
    "name": "Sesi√≥n de Prueba",
    "bingo_type": "75",
    "total_cards": 50,
    "entry_fee": 5.00,
    "scheduled_start": "2024-01-15T20:00:00Z"
  }'

# Generar cartones
curl -X POST http://localhost:8000/api/multi-tenant/cards/generate-for-session/ \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "session-uuid",
    "generate_now": true
  }'

# Ver cartones disponibles
curl http://localhost:8000/api/multi-tenant/sessions/session-uuid/available-cards/
```

---

## üîß Soluci√≥n de Problemas

### Error: "MultipleObjectsReturned"

**Problema:**
```
MultipleObjectsReturned at /api/multi-tenant/players/register-by-phone/
get() returned more than one Player
```

**Soluci√≥n:**
```bash
# Limpiar datos duplicados
python3 cleanup_duplicates.py
```

### Error: "no such table: bingo_operator"

**Problema:**
```
OperationalError: no such table: bingo_operator
```

**Soluci√≥n:**
```bash
python3 manage.py migrate
```

### Error: PostgreSQL Connection Failed

**Problema:**
```
could not connect to server
```

**Soluciones:**

1. Verificar PostgreSQL:
```bash
sudo systemctl status postgresql
sudo systemctl start postgresql
```

2. Crear base de datos:
```bash
createdb -U postgres bingo
```

3. Usar script de configuraci√≥n:
```bash
./setup_postgresql.sh
```

### Migraciones Desincronizadas

```bash
python3 manage.py makemigrations
python3 manage.py migrate
```

### Puerto Ya en Uso

```bash
# Cambiar puerto
python3 manage.py runserver 8001

# O matar proceso
pkill -f runserver
```

### Instalar psycopg

```bash
pip install psycopg==3.1.18
```

### Limpiar Sistema Completo

```bash
# Limpiar datos de demos
python3 cleanup_duplicates.py

# Resetear base de datos
python3 manage.py flush
python3 manage.py migrate
```

**Ver m√°s soluciones en:** `GUIA_SOLUCION_PROBLEMAS.md`

---

## üìÅ Estructura del Proyecto

```
bingo_service/
‚îú‚îÄ‚îÄ bingo/                          # App principal
‚îÇ   ‚îú‚îÄ‚îÄ migrations/                 # Migraciones de base de datos
‚îÇ   ‚îú‚îÄ‚îÄ models.py                   # Modelos de datos
‚îÇ   ‚îú‚îÄ‚îÄ views.py                    # Vistas b√°sicas
‚îÇ   ‚îú‚îÄ‚îÄ views_multi_tenant.py       # Vistas multi-tenant
‚îÇ   ‚îú‚îÄ‚îÄ serializers.py              # Serializers b√°sicos
‚îÇ   ‚îú‚îÄ‚îÄ serializers_multi_tenant.py # Serializers multi-tenant
‚îÇ   ‚îú‚îÄ‚îÄ urls.py                     # URLs b√°sicas
‚îÇ   ‚îú‚îÄ‚îÄ urls_multi_tenant.py        # URLs multi-tenant
‚îÇ   ‚îî‚îÄ‚îÄ admin.py                    # Configuraci√≥n del admin
‚îÇ
‚îú‚îÄ‚îÄ bingo_service/                  # Configuraci√≥n del proyecto
‚îÇ   ‚îú‚îÄ‚îÄ settings.py                 # Configuraci√≥n Django
‚îÇ   ‚îú‚îÄ‚îÄ urls.py                     # URLs principales
‚îÇ   ‚îî‚îÄ‚îÄ wsgi.py                     # WSGI config
‚îÇ
‚îú‚îÄ‚îÄ requirements.txt                # Dependencias
‚îú‚îÄ‚îÄ manage.py                       # Django management
‚îÇ
‚îú‚îÄ‚îÄ demo_pool_cartones.py          # Demo pool de cartones
‚îú‚îÄ‚îÄ demo_multi_tenant.py           # Demo multi-tenant
‚îú‚îÄ‚îÄ demo_75_balls.py               # Demo 75 bolas
‚îú‚îÄ‚îÄ test_models.py                 # Test de modelos
‚îú‚îÄ‚îÄ test_pool_simple.py            # Test simple
‚îÇ
‚îî‚îÄ‚îÄ DOCUMENTACION_COMPLETA.md      # Esta documentaci√≥n
```

---

## üìû Soporte y Contacto

Para m√°s informaci√≥n o soporte:

1. Revisar esta documentaci√≥n completa
2. Ejecutar los scripts de demo
3. Revisar logs en caso de errores
4. Verificar configuraci√≥n de PostgreSQL

---

## üéâ Conclusi√≥n

Este microservicio proporciona una soluci√≥n completa y robusta para gestionar juegos de bingo en l√≠nea con las siguientes ventajas:

‚úÖ **Multi-Tenant** - M√∫ltiples operadores aislados  
‚úÖ **Pool de Cartones** - Sistema eficiente de selecci√≥n  
‚úÖ **3 Tipos de Bingo** - M√°xima flexibilidad  
‚úÖ **APIs Completas** - Integraci√≥n f√°cil  
‚úÖ **PostgreSQL** - Base de datos robusta  
‚úÖ **Documentado** - Gu√≠as completas  

**¬°El sistema est√° listo para producci√≥n!** üé≤‚ú®

---

*Documentaci√≥n actualizada: 2024*
*Versi√≥n del Sistema: 2.0*
*Base de Datos: PostgreSQL*
